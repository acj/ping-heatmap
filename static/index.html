<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ICMP Ping â€” Subsecond Heatmap</title>

	<!-- Bootstrap -->
	<link href='bootstrap.min.css' rel='stylesheet' type='text/css'>

	<link href='chart.css' rel='stylesheet' type='text/css'>

	<style>
		body {
			padding-top: 20px;
			padding-bottom: 20px;
		}
	
		.container {
			max-width: 960px;
		}
	</style>
</head>
<body>
	<div class="container">
		<div id="chart"></div>
	</div>

	<script src="d3.v4.min.js" charset="utf-8"></script>
	
	<script>
		let margin = {top: 80, right: 25, bottom: 30, left: 40},
			width = 900 - margin.left - margin.right,
			height = 450 - margin.top - margin.bottom;

		let svg = d3.select("#chart")
					.append("svg")
					.attr("width", width + margin.left + margin.right)
					.attr("height", height + margin.top + margin.bottom)
					.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		function updateChart() {
			d3.json("/data.json", function (error, data) {
				if (error) return console.warn(error)

				let myGroups = d3.map(data, function(d) { return d.offset; }).keys()
				let myVars = d3.map(data, function(d) { return d["subsecond-offset"]; }).keys()

				let x = d3.scaleBand()
						.range([ 0, width ])
						.domain(myGroups)
						.padding(0.05);
				svg.append("g")
					.style("font-size", 15)
					.attr("transform", "translate(0, " + height + ")")
					.call(d3.axisBottom(x).tickSize(0))
					.select(".domain").remove()

				let y = d3.scaleBand()
						.range([ height, 0 ])
						.domain(myVars)
						.padding(0.05);
				svg.append("g")
					.style("font-size", 15)
					.call(d3.axisLeft(y).tickSize(0))
					.select(".domain").remove()

				svg.append("text")
					.attr("transform",
							"translate(" + (width/2) + ", " + (height + 28) + ")")
					.style("text-anchor", "middle")
					.style("font-weight", "bold")
					.style("fill", "black")
					.text("Rolling Time Offset (sec)");

				svg.append("text")
					.attr("transform", "rotate(-90)")
					.attr("y", 0 - margin.left)
					.attr("x", 0 - (height / 2))
					.attr("dy", "1em")
					.style("text-anchor", "middle")
					.style("font-weight", "bold")
					.style("fill", "black")
					.text("Time Subsecond Offset (ms)");

				let tooltip = d3.select("#chart")
								.append("div")
								.style("opacity", 0)
								.attr("class", "tooltip")
								.style("background-color", "white")
								.style("border", "solid")
								.style("border-width", "2px")
								.style("border-radius", "5px")
								.style("padding", "5px")

				let mouseover = function(d) {
					tooltip.style("opacity", 1)
					d3.select(this).style("stroke", "yellow")
									.style("opacity", 1)
				}
				let mousemove = function(d) {
					tooltip.html("Latency: " + d.latency + "ms")
							.style("left", (d3.mouse(this)[0] + 230) + "px")
							.style("top", (d3.mouse(this)[1] + 50) + "px")
				}
				let mouseleave = function(d) {
					tooltip.style("opacity", 0)
					d3.select(this).style("stroke", "none")
									.style("opacity", 0.8)
				}

				let determineColor = d3.scaleLinear()
										.domain([0, 65 / 2, 65])
										.range(['#F5F5DC', '#FF5032', '#E50914'])

				svg.selectAll()
					.data(data, function(d) { return d.offset+':'+d["subsecond-offset"]; })
					.enter()
					.append("rect")
					.style("stroke-width", 4)
					.style("stroke", "none")
					.style("fill", function(d) { return determineColor(d.latency)} )
					.attr("x", function(d) { return x(d.offset) })
					.attr("y", function(d) { return y(d["subsecond-offset"]) })
					.attr("width", x.bandwidth() )
					.attr("height", y.bandwidth() )
					.on("mouseover", mouseover)
					.on("mousemove", mousemove)
					.on("mouseleave", mouseleave)
			})
		}

		window.setInterval(updateChart, 1000);
	</script>
</body>
</html>